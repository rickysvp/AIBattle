import React from 'react';
import { Agent } from '../types';

interface PixelAgentProps {
  agent: Agent;
  size?: number;
  showHp?: boolean;
  isAttacking?: boolean;
  isHurt?: boolean;
}

// è¶…çº§é©¬é‡Œå¥¥é£æ ¼çš„åƒç´ äºº SVG
const PixelAgent: React.FC<PixelAgentProps> = ({ 
  agent, 
  size = 32, 
  showHp = false,
  isAttacking = false,
  isHurt = false,
}) => {
  const { color, hp, maxHp, pixelStyle } = agent;
  const hpPercent = (hp / maxHp) * 100;
  const isDead = hp <= 0;
  
  // æ ¹æ® pixelStyle é€‰æ‹©ä¸åŒçš„åƒç´ äººé€ å‹
  const getPixelPattern = () => {
    // åŸºç¡€åƒç´ äººå›¾æ¡ˆ - 16x16 ç½‘æ ¼
    // 0=é€æ˜, 1=ä¸»è‰², 2=æ·±è‰²(é˜´å½±), 3=æµ…è‰²(é«˜å…‰), 4=çš®è‚¤è‰², 5=çœ¼ç›ç™½, 6=çœ¼ç›é»‘
    const patterns = [
      // æ ·å¼0: ç»å…¸é©¬é‡Œå¥¥é£æ ¼æˆ˜å£«
      [
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,2,2,2,4,4,4,2,2,2,0,0,0,0],
        [0,0,2,4,2,4,4,4,4,4,2,4,2,0,0,0],
        [0,0,2,4,2,2,4,4,4,2,2,4,2,0,0,0],
        [0,0,0,4,4,4,4,4,4,4,4,4,0,0,0,0],
        [0,0,0,0,4,5,6,4,4,5,6,0,0,0,0,0],
        [0,0,0,0,4,4,4,2,4,4,4,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,1,1,1,3,1,1,1,3,1,1,1,0,0,0],
        [0,1,1,1,1,3,3,3,3,3,1,1,1,1,0,0],
        [0,4,4,1,1,1,1,1,1,1,1,1,4,4,0,0],
        [0,4,4,4,1,1,0,0,1,1,4,4,4,0,0,0],
        [0,0,2,2,2,2,0,0,2,2,2,2,0,0,0,0],
        [0,2,2,2,2,2,0,0,2,2,2,2,2,0,0,0],
      ],
      // æ ·å¼1: å¿è€…é£æ ¼
      [
        [0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],
        [0,0,0,0,2,2,2,2,2,2,2,2,0,0,0,0],
        [0,0,0,2,2,2,2,2,2,2,2,2,2,0,0,0],
        [0,0,2,2,2,2,2,2,2,2,2,2,2,2,0,0],
        [0,0,2,2,5,6,2,2,2,5,6,2,2,2,0,0],
        [0,0,0,2,2,2,2,2,2,2,2,2,2,0,0,0],
        [0,0,0,0,2,2,2,2,2,2,2,2,0,0,0,0],
        [0,0,0,0,0,2,4,4,4,2,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,4,1,1,1,1,1,1,1,1,1,4,0,0,0],
        [0,0,4,4,1,1,0,0,1,1,4,4,0,0,0,0],
        [0,0,0,2,2,2,0,0,2,2,2,0,0,0,0,0],
        [0,0,2,2,2,2,0,0,2,2,2,2,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // æ ·å¼2: æœºå™¨äººé£æ ¼
      [
        [0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0],
        [0,0,0,3,1,1,1,1,1,1,1,1,3,0,0,0],
        [0,0,3,1,1,1,1,1,1,1,1,1,1,3,0,0],
        [0,0,3,1,5,6,1,1,1,5,6,1,1,3,0,0],
        [0,0,3,1,1,1,1,1,1,1,1,1,1,3,0,0],
        [0,0,3,1,1,3,3,3,3,3,1,1,1,3,0,0],
        [0,0,0,3,1,1,1,1,1,1,1,1,3,0,0,0],
        [0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0],
        [0,0,0,0,2,1,1,1,1,1,1,2,0,0,0,0],
        [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
        [0,0,2,1,1,1,1,1,1,1,1,1,1,2,0,0],
        [0,0,2,1,1,1,1,1,1,1,1,1,1,2,0,0],
        [0,0,0,2,1,1,0,0,1,1,1,2,0,0,0,0],
        [0,0,0,2,2,2,0,0,2,2,2,2,0,0,0,0],
        [0,0,2,2,2,2,0,0,2,2,2,2,2,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // æ ·å¼3: éª‘å£«é£æ ¼
      [
        [0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,1,1,2,2,2,2,2,1,1,0,0,0,0],
        [0,0,1,1,2,2,2,2,2,2,2,1,1,0,0,0],
        [0,0,1,2,5,6,2,2,5,6,2,2,1,0,0,0],
        [0,0,1,2,2,2,2,2,2,2,2,2,1,0,0,0],
        [0,0,0,2,2,2,4,4,4,2,2,2,0,0,0,0],
        [0,0,0,0,2,4,4,4,4,4,2,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,4,1,1,1,0,0,1,1,1,4,0,0,0,0],
        [0,0,4,4,1,1,0,0,1,1,4,4,0,0,0,0],
        [0,0,2,2,2,2,0,0,2,2,2,2,0,0,0,0],
        [0,2,2,2,2,2,0,0,2,2,2,2,2,0,0,0],
      ],
      // æ ·å¼4: æ³•å¸ˆé£æ ¼
      [
        [0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,1,1,1,3,3,3,1,1,1,0,0,0,0],
        [0,0,1,1,1,3,3,3,3,3,1,1,1,0,0,0],
        [0,0,1,1,3,3,3,3,3,3,3,1,1,0,0,0],
        [0,0,0,4,4,4,4,4,4,4,4,4,0,0,0,0],
        [0,0,4,4,5,6,4,4,4,5,6,4,4,0,0,0],
        [0,0,4,4,4,4,4,4,4,4,4,4,4,0,0,0],
        [0,0,0,4,4,4,4,2,4,4,4,4,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,4,4,1,0,0,1,4,4,0,0,0,0,0],
        [0,0,0,4,4,4,0,0,4,4,4,0,0,0,0,0],
        [0,0,2,2,2,2,0,0,2,2,2,2,0,0,0,0],
      ],
      // æ ·å¼5: æªæ‰‹é£æ ¼
      [
        [0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,4,4,4,4,4,4,4,4,4,0,0,0,0],
        [0,0,4,4,5,6,4,4,4,5,6,4,4,0,0,0],
        [0,0,4,4,4,4,4,4,4,4,4,4,4,0,0,0],
        [0,0,0,4,4,4,4,2,4,4,4,4,0,0,0,0],
        [0,0,0,0,4,4,4,4,4,4,4,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,2,2,0],
        [0,0,4,1,1,1,1,1,1,1,1,1,2,2,2,0],
        [0,0,4,4,1,1,0,0,1,1,4,4,0,0,0,0],
        [0,0,0,2,2,2,0,0,2,2,2,0,0,0,0,0],
        [0,0,2,2,2,2,0,0,2,2,2,2,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ];
    
    return patterns[pixelStyle % patterns.length];
  };
  
  const pattern = getPixelPattern();
  
  // é¢œè‰²æ˜ å°„
  const getColor = (value: number) => {
    switch (value) {
      case 0: return 'transparent';
      case 1: return color;
      case 2: return adjustBrightness(color, -50);
      case 3: return adjustBrightness(color, 60);
      case 4: return '#fcd5b8'; // çš®è‚¤è‰²
      case 5: return '#ffffff'; // çœ¼ç›ç™½
      case 6: return '#1a1a2e'; // çœ¼ç›é»‘
      default: return 'transparent';
    }
  };
  
  return (
    <div 
      className={`relative transition-transform duration-100
        ${isAttacking ? 'scale-110' : ''}
        ${isHurt ? 'animate-shake' : ''}`}
      style={{ 
        width: size, 
        height: size + (showHp ? 10 : 0),
        opacity: isDead ? 0.4 : 1,
        filter: isDead ? 'grayscale(100%)' : 'none',
      }}
    >
      {/* HP æ¡ */}
      {showHp && !isDead && (
        <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-full max-w-[40px] h-1.5 bg-gray-800/80 rounded-full overflow-hidden border border-gray-700/50">
          <div 
            className="h-full transition-all duration-300 rounded-full"
            style={{ 
              width: `${hpPercent}%`,
              backgroundColor: hpPercent > 60 ? '#22c55e' : hpPercent > 30 ? '#eab308' : '#ef4444',
              boxShadow: `0 0 4px ${hpPercent > 60 ? '#22c55e' : hpPercent > 30 ? '#eab308' : '#ef4444'}`
            }}
          />
        </div>
      )}
      
      {/* åƒç´ äºº SVG */}
      <svg 
        width={size} 
        height={size} 
        viewBox="0 0 16 16"
        className="pixelated drop-shadow-lg"
        style={{ 
          filter: isHurt ? 'brightness(2) saturate(0.5)' : isDead ? 'grayscale(1)' : 'none',
          transform: isAttacking ? 'translateX(3px)' : 'none',
          transition: 'all 0.1s ease',
        }}
      >
        {pattern.map((row, y) => 
          row.map((cell, x) => 
            cell !== 0 && (
              <rect
                key={`${x}-${y}`}
                x={x}
                y={y}
                width={1.05}
                height={1.05}
                fill={getColor(cell)}
              />
            )
          )
        )}
      </svg>
      
      {/* æ­»äº¡æ ‡è®° */}
      {isDead && (
        <div className="absolute inset-0 flex items-center justify-center">
          <span className="text-2xl opacity-80">ğŸ’€</span>
        </div>
      )}
      
      {/* æ”»å‡»ç‰¹æ•ˆ */}
      {isAttacking && (
        <div 
          className="absolute -right-2 top-1/2 -translate-y-1/2 text-sm"
          style={{ textShadow: `0 0 5px ${color}` }}
        >
          ğŸ’¥
        </div>
      )}
    </div>
  );
};

// è°ƒæ•´é¢œè‰²äº®åº¦
function adjustBrightness(color: string, amount: number): string {
  const hex = color.replace('#', '');
  const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
  const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
  const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

export default PixelAgent;
